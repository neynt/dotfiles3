#!/bin/bash

hostname=$(cat /etc/hostname 2>/dev/null || hostname)
if [[ "$hostname" == "saltblock-arch" ]]; then
  diary_root="/home/neynt/diary"
  is_macos=false
else
  diary_root="/Users/neynt/stash/diary"
  is_macos=true
fi

format_date() {
  local timestamp=$1
  if [[ "$is_macos" == "true" ]]; then
    date -r "$timestamp" "+%Y-%m-%d"
  else
    date -d "@$timestamp" "+%Y-%m-%d"
  fi
}

parse_date() {
  local input=$1
  case "$input" in
    yesterday)
      if [[ "$is_macos" == "true" ]]; then
        date -v-1d "+%s"
      else
        date -d "yesterday" "+%s"
      fi
      ;;
    tomorrow)
      if [[ "$is_macos" == "true" ]]; then
        date -v+1d "+%s"
      else
        date -d "tomorrow" "+%s"
      fi
      ;;
    today)
      date "+%s"
      ;;
    *[0-9]*-*[0-9]*-*[0-9]*)
      if [[ "$is_macos" == "true" ]]; then
        date -j -f "%Y-%m-%d" "$input" "+%s"
      else
        date -d "$input" "+%s"
      fi
      ;;
    *)
      echo "Error: Invalid date format. Use 'yesterday', 'today', 'tomorrow', or YYYY-MM-DD" >&2
      exit 1
      ;;
  esac
}

specified_date=""
while [[ $# -gt 0 ]]; do
  case "$1" in
    -d|--date)
      specified_date="$2"
      shift 2
      ;;
    *)
      echo "Unknown option: $1"
      echo "Usage: $0 [-d|--date YYYY-MM-DD|yesterday|today|tomorrow]"
      exit 1
      ;;
  esac
done

if [[ ! -d "$diary_root" ]]; then
  echo "Diary directory does not exist: $diary_root"
  exit 1
fi

cd "$diary_root"

if [[ -n "$specified_date" ]]; then
  now=$(parse_date "$specified_date")
else
  now=$(date "+%s")
fi

yyyymmdd=$(format_date $((now - 3600 * 4)))
yyyy="${yyyymmdd%%-*}"
mm="${yyyymmdd:5:2}"
dd="${yyyymmdd:8:2}"

mkdir -p "$yyyy"

today_file="$yyyy/$yyyy-$mm-$dd.md"

# Initialize new diary file with path to last diary entry if it doesn't exist
if [[ ! -f "$today_file" ]]; then
  # Find the most recent diary file in the year directories
  last_file=$(find "$diary_root" -path "*/????/*.md" -name "????-??-??.md" -type f | sort | tail -1)
  if [[ -n "$last_file" ]]; then
    echo "Last entry: $last_file" > "$today_file"
    echo "" >> "$today_file"
  fi
fi

$EDITOR "$today_file"

blue="\033[1;34m"
green="\033[1;32m"
nocolor="\033[0m"
echo
cat prompt.md
for days_ago in 365 90 30 7 2 1 0; do
  yyyymmdd=$(format_date $((now - 3600 * 4 - 86400 * days_ago)))
  file="${yyyymmdd%%-*}/$yyyymmdd.md"
  if [[ -f "$file" ]]; then
    echo
    printf "${green}## $yyyymmdd ($days_ago days ago, %d words)${nocolor}\n" "$(wc -w < "$file")"
    echo
    cat "$file"
    echo
  fi
done

if [[ -f "$today_file" ]]; then
  echo
  printf "${blue}You wrote %d words today.${nocolor}\n" "$(wc -w < "$today_file")"
fi
